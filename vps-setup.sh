#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ VPS Ð´Ð»Ñ habbits
# Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¾Ñ‚ root Ð¸Ð»Ð¸ Ñ sudo

set -e

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPS Ð´Ð»Ñ habbits..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹..."
apt-get update
apt-get upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
if ! command -v docker &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    usermod -aG docker gleb
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ docker compose plugin ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
if ! docker compose version &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker Compose plugin..."
    apt-get install -y docker-compose-plugin
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ nginx ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
if ! command -v nginx &> /dev/null; then
    echo "ðŸŒ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Nginx..."
    apt-get install -y nginx
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ certbot Ð´Ð»Ñ SSL
if ! command -v certbot &> /dev/null; then
    echo "ðŸ”’ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Certbot..."
    apt-get install -y certbot python3-certbot-nginx
fi

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
mkdir -p /opt/habbits
chown gleb:gleb /opt/habbits

# ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
if [ ! -d "/opt/habbits/.git" ]; then
    echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
    sudo -u gleb git clone https://github.com/hlebgleb/habbits.git /opt/habbits
fi

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ webhook
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
cat > /etc/systemd/system/habbits-webhook.service << 'EOF'
[Unit]
Description=Habbits Deploy Webhook Server
After=network.target

[Service]
Type=simple
User=gleb
WorkingDirectory=/opt/habbits
Environment=WEBHOOK_SECRET=habbits-deploy-secret-2026
ExecStart=/usr/bin/python3 /opt/habbits/webhook-server.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
systemctl daemon-reload
systemctl enable habbits-webhook
systemctl start habbits-webhook

echo "âœ… Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» /opt/habbits/.env Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ"
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: cd /opt/habbits && docker compose up -d"
echo "3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ nginx (ÑÐ¼. nginx-habbits.conf)"
echo "4. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ webhook Ð² GitHub: http://YOUR_IP:9000/deploy"
